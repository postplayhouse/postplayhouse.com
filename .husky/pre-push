#!/usr/bin/env sh
# bd-shim v1
# bd-hooks-version: 0.46.0
#
# bd (beads) pre-push hook - thin shim
#
# This shim delegates to 'bd hooks run pre-push' which contains
# the actual hook logic. This pattern ensures hook behavior is always
# in sync with the installed bd version - no manual updates needed.

# Check if bd is available
if ! command -v bd >/dev/null 2>&1; then
    echo "Warning: bd command not found in PATH, skipping pre-push hook" >&2
    echo "  Install bd: brew install steveyegge/tap/bd" >&2
    echo "  Or add bd to your PATH" >&2
    exit 0
fi

exec bd hooks run pre-push "$@"

# End beads pre-push hook

while read local_ref local_sha remote_ref remote_sha
do
# Only run svelte-check when pushing to origin/master
  if [ "$remote_ref" = "refs/heads/master" ]; then
    # Check if working directory is clean
    if [ -n "$(git status --porcelain)" ]; then
      echo "Working directory is not clean. Please commit or stash your changes before pushing to master."
      exit 1
    fi
    
    if ! (pnpm run check && pnpm run test:unit --run); then
      echo "Pre-push checks failed. Push aborted."
      exit 1
    fi
    break
  fi
done